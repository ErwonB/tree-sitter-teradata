================================================================================
Procedure
================================================================================

REPLACE PROCEDURE proc.Create_Mul_Col_Only_CS_SP  (
   IN in_db_name VARCHAR(64)
 , IN in_table_name VARCHAR(255)
 , IN in_work_tablename VARCHAR(255)
  , OUT Ret_Code  INTEGER)
-- Return Code 0 - Successful
-- Return Code -1 - No tables found
-- non 0         - Exception
Run_Mul_Col_Only_CS_SP:
BEGIN
--  30 *(64+2) object names should fit within 3000 characters
DECLARE  CS_SQL_Text VARCHAR(3000);
DECLARE  cs_count INTEGER;

DECLARE EXIT HANDLER
FOR SQLEXCEPTION                  -- Exception Handling
BEGIN
SET Ret_Code = SQLCODE;
end;

-- Tables_for_CS is the cursor which reads column names from dbc.indicesV
-- and dbc.ALL_RI_childrenV, eliminating duplicate column names
-- and single column indices (latter not including referenced columns)

SEL COUNT(*)
INTO :cs_count
FROM (
SEL databasename cs_dname
   ,TABLENAME cs_tname
   ,columnname cs_cname
FROM dbc.indicesV
WHERE databasename = :in_db_name
AND (TRIM(TABLENAME) LIKE TRIM(:in_table_name) ESCAPE '\' OR TRIM(:in_table_name) = '')
AND indextype IN ('P','S','Q','K','V')
AND (cs_dname,cs_tname,cs_cname) IN
   (SEL databasename cs_dname2
   ,TABLENAME cs_tname2
   ,columnname cs_cname2
   FROM dbc.indicesV
   WHERE databasename = :in_db_name
   AND (TRIM(TABLENAME) LIKE TRIM(:in_table_name) ESCAPE '\' OR TRIM(:in_table_name) = '')
   AND indextype IN ('P','S','Q','K','V')
   AND (cs_dname2,cs_tname2,indexnumber) IN
     (SELECT databasename
      ,TABLENAME
      ,indexnumber
      FROM dbc.indicesV
      WHERE databasename = :in_db_name
      AND (TRIM(TABLENAME) LIKE TRIM(:in_table_name) ESCAPE '\' OR TRIM(:in_table_name) = '')
      AND indextype IN ('P','S','Q','K','V')
      GROUP BY 1,2,3
            HAVING MAX(columnposition) > 1)
   GROUP BY 1,2,3)
UNION
SEL ch.ChildDB cs_dname
   ,ch.ChildTable cs_tname
   ,ch.ChildKeyColumn cs_cname
FROM  dbc.ALL_RI_childrenV ch
WHERE ch.childdb = :in_db_name
   AND (TRIM(ch.ChildTable) LIKE TRIM(:in_table_name) ESCAPE '\' OR TRIM(:in_table_name) = '')
) A;

IF cs_count = 0
  THEN
    SET Ret_Code = -1;
    LEAVE Run_Mul_Col_Only_CS_SP;
end if;

FOR Loop1 AS Tables_for_CS CURSOR FOR

SEL databasename cs_dname
   ,TABLENAME cs_tname
   ,columnname cs_cname
FROM dbc.indicesV
WHERE databasename = :in_db_name
AND (TRIM(TABLENAME) LIKE TRIM(:in_table_name) ESCAPE '\' OR TRIM(:in_table_name) = '')
AND indextype IN ('P','S','Q','K','V')
AND (cs_dname,cs_tname,cs_cname) IN
   (SEL databasename cs_dname2
   ,TABLENAME cs_tname2
   ,columnname cs_cname2
   FROM dbc.indicesV
   WHERE databasename = :in_db_name
   AND (TRIM(TABLENAME) LIKE TRIM(:in_table_name) ESCAPE '\' OR TRIM(:in_table_name) = '')
   AND indextype IN ('P','S','Q','K','V')
   AND (cs_dname2,cs_tname2,indexnumber) IN
     (SELECT databasename
      ,TABLENAME
      ,indexnumber
      FROM dbc.indicesV
      WHERE databasename = :in_db_name
      AND (TRIM(TABLENAME) LIKE TRIM(:in_table_name) ESCAPE '\' OR TRIM(:in_table_name) = '')
      AND indextype IN ('P','S','Q','K','V')
      GROUP BY 1,2,3
      HAVING MAX(columnposition) > 1)
   GROUP BY 1,2,3)
UNION
SEL ch.ChildDB cs_dname
   ,ch.ChildTable cs_tname
   ,ch.ChildKeyColumn cs_cname
FROM  dbc.ALL_RI_childrenV ch
WHERE ch.childdb = :in_db_name
   AND (TRIM(ch.ChildTable) LIKE TRIM(:in_table_name) ESCAPE '\' OR TRIM(:in_table_name) = '')
ORDER BY 1,2,3

 DO

   SET CS_SQL_Text = 'collect statistics on ' || TRIM(Loop1.cs_dname) || '.' ||
     TRIM(Loop1.cs_tname) || ' column (' ||  TRIM(Loop1.cs_cname) || ');';

   CALL DBC.SysExecSQL ('insert into ' || TRIM(:in_work_tablename) ||
                        ' values (''' || :CS_SQL_Text || ''');');

end For; --Loop1

SET ret_code = 0;

END;
--------------------------------------------------------------------------------

    (program
      (statement
        (create_procedure
          (keyword_replace)
          (keyword_procedure)
          (object_reference
            (identifier)
            (identifier))
          (procedure_arguments
            (procedure_argument
              (keyword_in)
              (identifier)
              (varchar
                (keyword_varchar)
                (literal)))
            (procedure_argument
              (keyword_in)
              (identifier)
              (varchar
                (keyword_varchar)
                (literal)))
            (procedure_argument
              (keyword_in)
              (identifier)
              (varchar
                (keyword_varchar)
                (literal)))
            (procedure_argument
              (keyword_out)
              (identifier)
              (int
                (keyword_int))))
          (comment)
          (comment)
          (comment)
          (procedure_body
            (compound_statement
              (object_reference
                (identifier))
              (keyword_begin)
              (comment)
              (declare_statement
                (keyword_declare)
                (identifier)
                (varchar
                  (keyword_varchar)
                  (literal)))
              (declare_statement
                (keyword_declare)
                (identifier)
                (int
                  (keyword_int)))
              (declare_statement
                (keyword_declare)
                (keyword_exit)
                (keyword_handler)
                (keyword_for)
                (keyword_sqlexception)
                (comment)
                (compound_statement
                  (keyword_begin)
                  (statement
                    (set_statement
                      (keyword_set)
                      (object_reference
                        (identifier))
                      (identifier)))
                  (keyword_end)))
              (comment)
              (comment)
              (comment)
              (statement
                (select
                  (keyword_sel)
                  (select_expression
                    (term
                      (invocation
                        (object_reference
                          (identifier))
                        (term
                          (all_fields))))))
                (keyword_into)
                (select_expression
                  (term
                    (field
                      (identifier))))
                (from
                  (keyword_from)
                  (relation
                    (subquery
                      (set_operation
                        (select
                          (keyword_sel)
                          (select_expression
                            (term
                              (field
                                (identifier))
                              (identifier))
                            (term
                              (field
                                (identifier))
                              (identifier))
                            (term
                              (field
                                (identifier))
                              (identifier))))
                        (from
                          (keyword_from)
                          (relation
                            (object_reference
                              (identifier)
                              (identifier)))
                          (where
                            (keyword_where)
                            (binary_expression
                              (binary_expression
                                (binary_expression
                                  (binary_expression
                                    (field
                                      (identifier))
                                    (field
                                      (identifier)))
                                  (keyword_and)
                                  (parenthesized_expression
                                    (binary_expression
                                      (binary_expression
                                        (invocation
                                          (object_reference
                                            (identifier))
                                          (term
                                            (field
                                              (identifier))))
                                        (keyword_like)
                                        (invocation
                                          (object_reference
                                            (identifier))
                                          (term
                                            (field
                                              (identifier))))
                                        (keyword_escape))
                                      (keyword_or)
                                      (binary_expression
                                        (invocation
                                          (object_reference
                                            (identifier))
                                          (term
                                            (field
                                              (identifier))))
                                        (literal)))))
                                (keyword_and)
                                (binary_expression
                                  (field
                                    (identifier))
                                  (keyword_in)
                                  (list
                                    (literal)
                                    (literal)
                                    (literal)
                                    (literal)
                                    (literal))))
                              (keyword_and)
                              (binary_expression
                                (list
                                  (field
                                    (identifier))
                                  (field
                                    (identifier))
                                  (field
                                    (identifier)))
                                (keyword_in)
                                (subquery
                                  (select
                                    (keyword_sel)
                                    (select_expression
                                      (term
                                        (field
                                          (identifier))
                                        (identifier))
                                      (term
                                        (field
                                          (identifier))
                                        (identifier))
                                      (term
                                        (field
                                          (identifier))
                                        (identifier))))
                                  (from
                                    (keyword_from)
                                    (relation
                                      (object_reference
                                        (identifier)
                                        (identifier)))
                                    (where
                                      (keyword_where)
                                      (binary_expression
                                        (binary_expression
                                          (binary_expression
                                            (binary_expression
                                              (field
                                                (identifier))
                                              (field
                                                (identifier)))
                                            (keyword_and)
                                            (parenthesized_expression
                                              (binary_expression
                                                (binary_expression
                                                  (invocation
                                                    (object_reference
                                                      (identifier))
                                                    (term
                                                      (field
                                                        (identifier))))
                                                  (keyword_like)
                                                  (invocation
                                                    (object_reference
                                                      (identifier))
                                                    (term
                                                      (field
                                                        (identifier))))
                                                  (keyword_escape))
                                                (keyword_or)
                                                (binary_expression
                                                  (invocation
                                                    (object_reference
                                                      (identifier))
                                                    (term
                                                      (field
                                                        (identifier))))
                                                  (literal)))))
                                          (keyword_and)
                                          (binary_expression
                                            (field
                                              (identifier))
                                            (keyword_in)
                                            (list
                                              (literal)
                                              (literal)
                                              (literal)
                                              (literal)
                                              (literal))))
                                        (keyword_and)
                                        (binary_expression
                                          (list
                                            (field
                                              (identifier))
                                            (field
                                              (identifier))
                                            (field
                                              (identifier)))
                                          (keyword_in)
                                          (subquery
                                            (select
                                              (keyword_select)
                                              (select_expression
                                                (term
                                                  (field
                                                    (identifier)))
                                                (term
                                                  (field
                                                    (identifier)))
                                                (term
                                                  (field
                                                    (identifier)))))
                                            (from
                                              (keyword_from)
                                              (relation
                                                (object_reference
                                                  (identifier)
                                                  (identifier)))
                                              (where
                                                (keyword_where)
                                                (binary_expression
                                                  (binary_expression
                                                    (binary_expression
                                                      (field
                                                        (identifier))
                                                      (field
                                                        (identifier)))
                                                    (keyword_and)
                                                    (parenthesized_expression
                                                      (binary_expression
                                                        (binary_expression
                                                          (invocation
                                                            (object_reference
                                                              (identifier))
                                                            (term
                                                              (field
                                                                (identifier))))
                                                          (keyword_like)
                                                          (invocation
                                                            (object_reference
                                                              (identifier))
                                                            (term
                                                              (field
                                                                (identifier))))
                                                          (keyword_escape))
                                                        (keyword_or)
                                                        (binary_expression
                                                          (invocation
                                                            (object_reference
                                                              (identifier))
                                                            (term
                                                              (field
                                                                (identifier))))
                                                          (literal)))))
                                                  (keyword_and)
                                                  (binary_expression
                                                    (field
                                                      (identifier))
                                                    (keyword_in)
                                                    (list
                                                      (literal)
                                                      (literal)
                                                      (literal)
                                                      (literal)
                                                      (literal)))))
                                              (group_by
                                                (keyword_group)
                                                (keyword_by)
                                                (literal)
                                                (literal)
                                                (literal))
                                                (having
                                                (keyword_having)
                                                (binary_expression
                                                  (invocation
                                                    (object_reference
                                                      (identifier))
                                                    (term
                                                      (field
                                                        (identifier))))
                                                  (literal))))))))
                                    (group_by
                                      (keyword_group)
                                      (keyword_by)
                                      (literal)
                                      (literal)
                                      (literal))))))))
                        (keyword_union)
                        (select
                          (keyword_sel)
                          (select_expression
                            (term
                              (field
                                (object_reference
                                  (identifier))
                                (identifier))
                              (identifier))
                            (term
                              (field
                                (object_reference
                                  (identifier))
                                (identifier))
                              (identifier))
                            (term
                              (field
                                (object_reference
                                  (identifier))
                                (identifier))
                              (identifier))))
                        (from
                          (keyword_from)
                          (relation
                            (object_reference
                              (identifier)
                              (identifier))
                            (identifier))
                          (where
                            (keyword_where)
                            (binary_expression
                              (binary_expression
                                (field
                                  (object_reference
                                    (identifier))
                                  (identifier))
                                (field
                                  (identifier)))
                              (keyword_and)
                              (parenthesized_expression
                                (binary_expression
                                  (binary_expression
                                    (invocation
                                      (object_reference
                                        (identifier))
                                      (term
                                        (field
                                          (object_reference
                                            (identifier))
                                          (identifier))))
                                    (keyword_like)
                                    (invocation
                                      (object_reference
                                        (identifier))
                                      (term
                                        (field
                                          (identifier))))
                                    (keyword_escape))
                                  (keyword_or)
                                  (binary_expression
                                    (invocation
                                      (object_reference
                                        (identifier))
                                      (term
                                        (field
                                          (identifier))))
                                    (literal)))))))))
                    (identifier))))
              (procedure_if_statement
                (keyword_if)
                (binary_expression
                  (field
                    (identifier))
                  (literal))
                (keyword_then)
                (statement
                  (set_statement
                    (keyword_set)
                    (object_reference
                      (identifier))
                    (literal)))
                (leave_statement
                  (keyword_leave)
                  (identifier))
                (keyword_end)
                (keyword_if))
              (procedure_for_statement
                (keyword_for)
                (identifier)
                (keyword_as)
                (identifier)
                (keyword_cursor)
                (keyword_for)
                (statement
                  (set_operation
                    (select
                      (keyword_sel)
                      (select_expression
                        (term
                          (field
                            (identifier))
                          (identifier))
                        (term
                          (field
                            (identifier))
                          (identifier))
                        (term
                          (field
                            (identifier))
                          (identifier))))
                    (from
                      (keyword_from)
                      (relation
                        (object_reference
                          (identifier)
                          (identifier)))
                      (where
                        (keyword_where)
                        (binary_expression
                          (binary_expression
                            (binary_expression
                              (binary_expression
                                (field
                                  (identifier))
                                (field
                                  (identifier)))
                              (keyword_and)
                              (parenthesized_expression
                                (binary_expression
                                  (binary_expression
                                    (invocation
                                      (object_reference
                                        (identifier))
                                      (term
                                        (field
                                          (identifier))))
                                    (keyword_like)
                                    (invocation
                                      (object_reference
                                        (identifier))
                                      (term
                                        (field
                                          (identifier))))
                                    (keyword_escape))
                                  (keyword_or)
                                  (binary_expression
                                    (invocation
                                      (object_reference
                                        (identifier))
                                      (term
                                        (field
                                          (identifier))))
                                    (literal)))))
                            (keyword_and)
                            (binary_expression
                              (field
                                (identifier))
                              (keyword_in)
                              (list
                                (literal)
                                (literal)
                                (literal)
                                (literal)
                                (literal))))
                          (keyword_and)
                          (binary_expression
                            (list
                              (field
                                (identifier))
                              (field
                                (identifier))
                              (field
                                (identifier)))
                            (keyword_in)
                            (subquery
                              (select
                                (keyword_sel)
                                (select_expression
                                  (term
                                    (field
                                      (identifier))
                                    (identifier))
                                  (term
                                    (field
                                      (identifier))
                                    (identifier))
                                  (term
                                    (field
                                      (identifier))
                                    (identifier))))
                              (from
                                (keyword_from)
                                (relation
                                  (object_reference
                                    (identifier)
                                    (identifier)))
                                (where
                                  (keyword_where)
                                  (binary_expression
                                    (binary_expression
                                      (binary_expression
                                        (binary_expression
                                          (field
                                            (identifier))
                                          (field
                                            (identifier)))
                                        (keyword_and)
                                        (parenthesized_expression
                                          (binary_expression
                                            (binary_expression
                                              (invocation
                                                (object_reference
                                                  (identifier))
                                                (term
                                                  (field
                                                    (identifier))))
                                              (keyword_like)
                                              (invocation
                                                (object_reference
                                                  (identifier))
                                                (term
                                                  (field
                                                    (identifier))))
                                              (keyword_escape))
                                            (keyword_or)
                                            (binary_expression
                                              (invocation
                                                (object_reference
                                                  (identifier))
                                                (term
                                                  (field
                                                    (identifier))))
                                              (literal)))))
                                      (keyword_and)
                                      (binary_expression
                                        (field
                                          (identifier))
                                        (keyword_in)
                                        (list
                                          (literal)
                                          (literal)
                                          (literal)
                                          (literal)
                                          (literal))))
                                    (keyword_and)
                                    (binary_expression
                                      (list
                                        (field
                                          (identifier))
                                        (field
                                          (identifier))
                                        (field
                                          (identifier)))
                                      (keyword_in)
                                      (subquery
                                        (select
                                          (keyword_select)
                                          (select_expression
                                            (term
                                              (field
                                                (identifier)))
                                            (term
                                              (field
                                                (identifier)))
                                            (term
                                              (field
                                                (identifier)))))
                                        (from
                                          (keyword_from)
                                          (relation
                                            (object_reference
                                              (identifier)
                                              (identifier)))
                                          (where
                                            (keyword_where)
                                            (binary_expression
                                              (binary_expression
                                                (binary_expression
                                                  (field
                                                    (identifier))
                                                  (field
                                                    (identifier)))
                                                (keyword_and)
                                                (parenthesized_expression
                                                  (binary_expression
                                                    (binary_expression
                                                      (invocation
                                                        (object_reference
                                                          (identifier))
                                                        (term
                                                          (field
                                                            (identifier))))
                                                      (keyword_like)
                                                      (invocation
                                                        (object_reference
                                                          (identifier))
                                                        (term
                                                          (field
                                                            (identifier))))
                                                      (keyword_escape))
                                                    (keyword_or)
                                                    (binary_expression
                                                      (invocation
                                                        (object_reference
                                                          (identifier))
                                                        (term
                                                          (field
                                                            (identifier))))
                                                      (literal)))))
                                              (keyword_and)
                                              (binary_expression
                                                (field
                                                  (identifier))
                                                (keyword_in)
                                                (list
                                                  (literal)
                                                  (literal)
                                                  (literal)
                                                  (literal)
                                                  (literal)))))
                                          (group_by
                                            (keyword_group)
                                            (keyword_by)
                                            (literal)
                                            (literal)
                                            (literal))
                                            (having
                                            (keyword_having)
                                            (binary_expression
                                              (invocation
                                                (object_reference
                                                  (identifier))
                                                (term
                                                  (field
                                                    (identifier))))
                                              (literal))))))))
                                (group_by
                                  (keyword_group)
                                  (keyword_by)
                                  (literal)
                                  (literal)
                                  (literal))))))))
                    (keyword_union)
                    (select
                      (keyword_sel)
                      (select_expression
                        (term
                          (field
                            (object_reference
                              (identifier))
                            (identifier))
                          (identifier))
                        (term
                          (field
                            (object_reference
                              (identifier))
                            (identifier))
                          (identifier))
                        (term
                          (field
                            (object_reference
                              (identifier))
                            (identifier))
                          (identifier))))
                    (from
                      (keyword_from)
                      (relation
                        (object_reference
                          (identifier)
                          (identifier))
                        (identifier))
                      (where
                        (keyword_where)
                        (binary_expression
                          (binary_expression
                            (field
                              (object_reference
                                (identifier))
                              (identifier))
                            (field
                              (identifier)))
                          (keyword_and)
                          (parenthesized_expression
                            (binary_expression
                              (binary_expression
                                (invocation
                                  (object_reference
                                    (identifier))
                                  (term
                                    (field
                                      (object_reference
                                        (identifier))
                                      (identifier))))
                                (keyword_like)
                                (invocation
                                  (object_reference
                                    (identifier))
                                  (term
                                    (field
                                      (identifier))))
                                (keyword_escape))
                              (keyword_or)
                              (binary_expression
                                (invocation
                                  (object_reference
                                    (identifier))
                                  (term
                                    (field
                                      (identifier))))
                                (literal))))))
                      (order_by
                        (keyword_order)
                        (keyword_by)
                        (order_target
                          (literal))
                        (order_target
                          (literal))
                        (order_target
                          (literal))))))
                (keyword_do)
                (statement
                  (set_statement
                    (keyword_set)
                    (object_reference
                      (identifier))
                    (binary_expression
                      (binary_expression
                        (binary_expression
                          (binary_expression
                            (binary_expression
                              (binary_expression
                                (literal)
                                (op_other)
                                (invocation
                                  (object_reference
                                    (identifier))
                                  (term
                                    (field
                                      (object_reference
                                        (identifier))
                                      (identifier)))))
                              (op_other)
                              (literal))
                            (op_other)
                            (invocation
                              (object_reference
                                (identifier))
                              (term
                                (field
                                  (object_reference
                                    (identifier))
                                  (identifier)))))
                          (op_other)
                          (literal))
                        (op_other)
                        (invocation
                          (object_reference
                            (identifier))
                          (term
                            (field
                              (object_reference
                                (identifier))
                              (identifier)))))
                      (op_other)
                      (literal))))
                (statement
                  (procedure
                    (keyword_call)
                    (object_reference
                      (identifier)
                      (identifier))
                    (binary_expression
                      (binary_expression
                        (binary_expression
                          (binary_expression
                            (literal)
                            (op_other)
                            (invocation
                              (object_reference
                                (identifier))
                              (term
                                (field
                                  (identifier)))))
                          (op_other)
                          (literal))
                        (op_other)
                        (field
                          (identifier)))
                      (op_other)
                      (literal))))
                (keyword_end)
                (keyword_for))
              (comment)
              (statement
                (set_statement
                  (keyword_set)
                  (object_reference
                    (identifier))
                  (literal)))
              (keyword_end))))))


================================================================================
Procedure 2
================================================================================

REPLACE PROCEDURE plop.Create_Index_CS_SP  (
   IN in_db_name VARCHAR(64)
 , IN in_table_name VARCHAR(255)
 , IN in_work_tablename VARCHAR(255)
 , OUT Ret_Code  INTEGER)
-- Return Code 0 - Successful
-- Return Code -1 - No tables found
-- non 0         - Exception

Run_Index_CS_SP:
BEGIN
DECLARE  Actvty_Flg  INTEGER;
--  30 *(64+2) object names should fit within 3000 characters
DECLARE  CS_SQL_Text VARCHAR(3000);
DECLARE  cs_count INTEGER;

DECLARE EXIT HANDLER
FOR SQLEXCEPTION                  -- Exception Handling
BEGIN
SET Ret_Code = SQLCODE;
end;

-- Set initial variables to control the loop
  SET Actvty_Flg=1;

-- Loop1 is the outside loop.  Tables_for_CS is the cursor which reads dbc.indicesV.
-- The result is a list of tablenames and index numbers grouped.
-- The initial CS SQL lines are initialized at the start of each iteration of Loop1

SEL COUNT(*)
INTO :cs_count
FROM dbc.indicesV
WHERE databasename = :in_db_name
AND (TRIM(TABLENAME) LIKE TRIM(:in_table_name) ESCAPE '\' OR TRIM(:in_table_name) = '')
AND indextype IN ('P','S','Q','K','V','I');

IF cs_count = 0
  THEN
    SET Ret_Code = -1;
    LEAVE Run_Index_CS_SP;
end if;

FOR Loop1 AS Tables_for_CS CURSOR FOR
SEL databasename cs_dname
   ,TABLENAME cs_tname
   ,indexnumber cs_inbr
   ,indextype cs_indextype
   ,indexname cs_indexname
FROM dbc.indicesV
WHERE databasename = :in_db_name
AND (TRIM(TABLENAME) LIKE TRIM(:in_table_name) ESCAPE '\' OR TRIM(:in_table_name) = '')
AND indextype IN ('P','S','Q','K','V','I')
GROUP BY 1,2,3,4,5
ORDER BY 1,2,3,4,5
 DO
   IF Loop1.cs_indextype = 'I'
     THEN
       SET CS_SQL_Text = 'collect statistics on ' || TRIM(Loop1.cs_dname) || '.' ||
         TRIM(Loop1.cs_tname) || ' column ';
     ELSE
       SET CS_SQL_Text = 'collect statistics on ' || TRIM(Loop1.cs_dname) || '.' ||
         TRIM(Loop1.cs_tname) || ' index ';
   end if;

-- If we have an indexname, then simply CS on the name.  Otherwise, we
-- read the columns for the index and build the index specification.


   IF Loop1.cs_indexname IS NOT NULL
     THEN
       SET CS_SQL_Text = 'collect statistics on ' || TRIM(Loop1.cs_dname) || '.' ||
              TRIM(Loop1.cs_tname) || ' index ' || TRIM(Loop1.cs_indexname) || ';';
       CALL DBC.SysExecSQL ('insert into ' || TRIM(:in_work_tablename) ||
                            ' values (''' || :CS_SQL_Text || ''');');
     ELSE

-- Loop2 is the inner loop.  Columns_for_CS is the cursor that reads dbc.indicesV for the column names.
-- This cursor needs to be refreshed for each iteration based on the indexnumber.
-- Logic is needed to determine if it is the first column to control the use of commas.
       FOR Loop2 AS Columns_for_CS CURSOR FOR
         SEL columnname cs_cname
         FROM dbc.indicesV
         WHERE databasename = :in_db_name
         AND indextype IN ('P','S','Q','K','V','I')
         AND databasename = :Loop1.cs_dname
         AND TABLENAME = :Loop1.cs_tname
         AND indexnumber = :Loop1.cs_inbr
         AND indextype = :Loop1.cs_indextype
         ORDER BY columnposition
       DO
       IF Actvty_Flg = 1
         THEN
           SET Actvty_Flg=2;
           SET CS_SQL_Text = CS_SQL_Text || '(' ||  TRIM(Loop2.cs_cname);
         ELSE
           SET CS_SQL_Text = CS_SQL_Text || ',' ||  TRIM(Loop2.cs_cname);
       End If;

       end For;  -- Loop2

--  At the completion of the inner loop, finish the SQL line and call DBC.SysExecSQL.

       SET Actvty_Flg=1;
       SET CS_SQL_Text = CS_SQL_Text || ');';

       CALL DBC.SysExecSQL ('insert into ' || TRIM(:in_work_tablename) ||
                            ' values (''' || :CS_SQL_Text || ''');');

   End If; -- Unnamed Index
end For; --Loop1

SET ret_code = 0;

END;

--------------------------------------------------------------------------------

    (program
      (statement
        (create_procedure
          (keyword_replace)
          (keyword_procedure)
          (object_reference
            (identifier)
            (identifier))
          (procedure_arguments
            (procedure_argument
              (keyword_in)
              (identifier)
              (varchar
                (keyword_varchar)
                (literal)))
            (procedure_argument
              (keyword_in)
              (identifier)
              (varchar
                (keyword_varchar)
                (literal)))
            (procedure_argument
              (keyword_in)
              (identifier)
              (varchar
                (keyword_varchar)
                (literal)))
            (procedure_argument
              (keyword_out)
              (identifier)
              (int
                (keyword_int))))
          (comment)
          (comment)
          (comment)
          (procedure_body
            (compound_statement
              (object_reference
                (identifier))
              (keyword_begin)
              (declare_statement
                (keyword_declare)
                (identifier)
                (int
                  (keyword_int)))
              (comment)
              (declare_statement
                (keyword_declare)
                (identifier)
                (varchar
                  (keyword_varchar)
                  (literal)))
              (declare_statement
                (keyword_declare)
                (identifier)
                (int
                  (keyword_int)))
              (declare_statement
                (keyword_declare)
                (keyword_exit)
                (keyword_handler)
                (keyword_for)
                (keyword_sqlexception)
                (comment)
                (compound_statement
                  (keyword_begin)
                  (statement
                    (set_statement
                      (keyword_set)
                      (object_reference
                        (identifier))
                      (identifier)))
                  (keyword_end)))
              (comment)
              (statement
                (set_statement
                  (keyword_set)
                  (object_reference
                    (identifier))
                  (literal)))
              (comment)
              (comment)
              (comment)
              (statement
                (select
                  (keyword_sel)
                  (select_expression
                    (term
                      (invocation
                        (object_reference
                          (identifier))
                        (term
                          (all_fields))))))
                (keyword_into)
                (select_expression
                  (term
                    (field
                      (identifier))))
                (from
                  (keyword_from)
                  (relation
                    (object_reference
                      (identifier)
                      (identifier)))
                  (where
                    (keyword_where)
                    (binary_expression
                      (binary_expression
                        (binary_expression
                          (field
                            (identifier))
                          (field
                            (identifier)))
                        (keyword_and)
                        (parenthesized_expression
                          (binary_expression
                            (binary_expression
                              (invocation
                                (object_reference
                                  (identifier))
                                (term
                                  (field
                                    (identifier))))
                              (keyword_like)
                              (invocation
                                (object_reference
                                  (identifier))
                                (term
                                  (field
                                    (identifier))))
                              (keyword_escape))
                            (keyword_or)
                            (binary_expression
                              (invocation
                                (object_reference
                                  (identifier))
                                (term
                                  (field
                                    (identifier))))
                              (literal)))))
                      (keyword_and)
                      (binary_expression
                        (field
                          (identifier))
                        (keyword_in)
                        (list
                          (literal)
                          (literal)
                          (literal)
                          (literal)
                          (literal)
                          (literal)))))))
              (procedure_if_statement
                (keyword_if)
                (binary_expression
                  (field
                    (identifier))
                  (literal))
                (keyword_then)
                (statement
                  (set_statement
                    (keyword_set)
                    (object_reference
                      (identifier))
                    (literal)))
                (leave_statement
                  (keyword_leave)
                  (identifier))
                (keyword_end)
                (keyword_if))
              (procedure_for_statement
                (keyword_for)
                (identifier)
                (keyword_as)
                (identifier)
                (keyword_cursor)
                (keyword_for)
                (statement
                  (select
                    (keyword_sel)
                    (select_expression
                      (term
                        (field
                          (identifier))
                        (identifier))
                      (term
                        (field
                          (identifier))
                        (identifier))
                      (term
                        (field
                          (identifier))
                        (identifier))
                      (term
                        (field
                          (identifier))
                        (identifier))
                      (term
                        (field
                          (identifier))
                        (identifier))))
                  (from
                    (keyword_from)
                    (relation
                      (object_reference
                        (identifier)
                        (identifier)))
                    (where
                      (keyword_where)
                      (binary_expression
                        (binary_expression
                          (binary_expression
                            (field
                              (identifier))
                            (field
                              (identifier)))
                          (keyword_and)
                          (parenthesized_expression
                            (binary_expression
                              (binary_expression
                                (invocation
                                  (object_reference
                                    (identifier))
                                  (term
                                    (field
                                      (identifier))))
                                (keyword_like)
                                (invocation
                                  (object_reference
                                    (identifier))
                                  (term
                                    (field
                                      (identifier))))
                                (keyword_escape))
                              (keyword_or)
                              (binary_expression
                                (invocation
                                  (object_reference
                                    (identifier))
                                  (term
                                    (field
                                      (identifier))))
                                (literal)))))
                        (keyword_and)
                        (binary_expression
                          (field
                            (identifier))
                          (keyword_in)
                          (list
                            (literal)
                            (literal)
                            (literal)
                            (literal)
                            (literal)
                            (literal)))))
                    (group_by
                      (keyword_group)
                      (keyword_by)
                      (literal)
                      (literal)
                      (literal)
                      (literal)
                      (literal))
                    (order_by
                      (keyword_order)
                      (keyword_by)
                      (order_target
                        (literal))
                      (order_target
                        (literal))
                      (order_target
                        (literal))
                      (order_target
                        (literal))
                      (order_target
                        (literal)))))
                (keyword_do)
                (procedure_if_statement
                  (keyword_if)
                  (binary_expression
                    (field
                      (object_reference
                        (identifier))
                      (identifier))
                    (literal))
                  (keyword_then)
                  (statement
                    (set_statement
                      (keyword_set)
                      (object_reference
                        (identifier))
                      (binary_expression
                        (binary_expression
                          (binary_expression
                            (binary_expression
                              (literal)
                              (op_other)
                              (invocation
                                (object_reference
                                  (identifier))
                                (term
                                  (field
                                    (object_reference
                                      (identifier))
                                    (identifier)))))
                            (op_other)
                            (literal))
                          (op_other)
                          (invocation
                            (object_reference
                              (identifier))
                            (term
                              (field
                                (object_reference
                                  (identifier))
                                (identifier)))))
                        (op_other)
                        (literal))))
                  (procedure_else_statement
                    (keyword_else)
                    (statement
                      (set_statement
                        (keyword_set)
                        (object_reference
                          (identifier))
                        (binary_expression
                          (binary_expression
                            (binary_expression
                              (binary_expression
                                (literal)
                                (op_other)
                                (invocation
                                  (object_reference
                                    (identifier))
                                  (term
                                    (field
                                      (object_reference
                                        (identifier))
                                      (identifier)))))
                              (op_other)
                              (literal))
                            (op_other)
                            (invocation
                              (object_reference
                                (identifier))
                              (term
                                (field
                                  (object_reference
                                    (identifier))
                                  (identifier)))))
                          (op_other)
                          (literal)))))
                  (keyword_end)
                  (keyword_if))
                (comment)
                (comment)
                (procedure_if_statement
                  (keyword_if)
                  (binary_expression
                    (field
                      (object_reference
                        (identifier))
                      (identifier))
                    (is_not
                      (keyword_is)
                      (keyword_not))
                    (literal
                      (keyword_null)))
                  (keyword_then)
                  (statement
                    (set_statement
                      (keyword_set)
                      (object_reference
                        (identifier))
                      (binary_expression
                        (binary_expression
                          (binary_expression
                            (binary_expression
                              (binary_expression
                                (binary_expression
                                  (literal)
                                  (op_other)
                                  (invocation
                                    (object_reference
                                      (identifier))
                                    (term
                                      (field
                                        (object_reference
                                          (identifier))
                                        (identifier)))))
                                (op_other)
                                (literal))
                              (op_other)
                              (invocation
                                (object_reference
                                  (identifier))
                                (term
                                  (field
                                    (object_reference
                                      (identifier))
                                    (identifier)))))
                            (op_other)
                            (literal))
                          (op_other)
                          (invocation
                            (object_reference
                              (identifier))
                            (term
                              (field
                                (object_reference
                                  (identifier))
                                (identifier)))))
                        (op_other)
                        (literal))))
                  (statement
                    (procedure
                      (keyword_call)
                      (object_reference
                        (identifier)
                        (identifier))
                      (binary_expression
                        (binary_expression
                          (binary_expression
                            (binary_expression
                              (literal)
                              (op_other)
                              (invocation
                                (object_reference
                                  (identifier))
                                (term
                                  (field
                                    (identifier)))))
                            (op_other)
                            (literal))
                          (op_other)
                          (field
                            (identifier)))
                        (op_other)
                        (literal))))
                  (procedure_else_statement
                    (keyword_else)
                    (comment)
                    (comment)
                    (comment)
                    (procedure_for_statement
                      (keyword_for)
                      (identifier)
                      (keyword_as)
                      (identifier)
                      (keyword_cursor)
                      (keyword_for)
                      (statement
                        (select
                          (keyword_sel)
                          (select_expression
                            (term
                              (field
                                (identifier))
                              (identifier))))
                        (from
                          (keyword_from)
                          (relation
                            (object_reference
                              (identifier)
                              (identifier)))
                          (where
                            (keyword_where)
                            (binary_expression
                              (binary_expression
                                (binary_expression
                                  (binary_expression
                                    (binary_expression
                                      (binary_expression
                                        (field
                                          (identifier))
                                        (field
                                          (identifier)))
                                      (keyword_and)
                                      (binary_expression
                                        (field
                                          (identifier))
                                        (keyword_in)
                                        (list
                                          (literal)
                                          (literal)
                                          (literal)
                                          (literal)
                                          (literal)
                                          (literal))))
                                    (keyword_and)
                                    (binary_expression
                                      (field
                                        (identifier))
                                      (field
                                        (object_reference
                                          (identifier))
                                        (identifier))))
                                  (keyword_and)
                                  (binary_expression
                                    (field
                                      (identifier))
                                    (field
                                      (object_reference
                                        (identifier))
                                      (identifier))))
                                (keyword_and)
                                (binary_expression
                                  (field
                                    (identifier))
                                  (field
                                    (object_reference
                                      (identifier))
                                    (identifier))))
                              (keyword_and)
                              (binary_expression
                                (field
                                  (identifier))
                                (field
                                  (object_reference
                                    (identifier))
                                  (identifier)))))
                          (order_by
                            (keyword_order)
                            (keyword_by)
                            (order_target
                              (field
                                (identifier))))))
                      (keyword_do)
                      (procedure_if_statement
                        (keyword_if)
                        (binary_expression
                          (field
                            (identifier))
                          (literal))
                        (keyword_then)
                        (statement
                          (set_statement
                            (keyword_set)
                            (object_reference
                              (identifier))
                            (literal)))
                        (statement
                          (set_statement
                            (keyword_set)
                            (object_reference
                              (identifier))
                            (binary_expression
                              (binary_expression
                                (field
                                  (identifier))
                                (op_other)
                                (literal))
                              (op_other)
                              (invocation
                                (object_reference
                                  (identifier))
                                (term
                                  (field
                                    (object_reference
                                      (identifier))
                                    (identifier)))))))
                        (procedure_else_statement
                          (keyword_else)
                          (statement
                            (set_statement
                              (keyword_set)
                              (object_reference
                                (identifier))
                              (binary_expression
                                (binary_expression
                                  (field
                                    (identifier))
                                  (op_other)
                                  (literal))
                                (op_other)
                                (invocation
                                  (object_reference
                                    (identifier))
                                  (term
                                    (field
                                      (object_reference
                                        (identifier))
                                      (identifier))))))))
                        (keyword_end)
                        (keyword_if))
                      (keyword_end)
                      (keyword_for))
                    (comment)
                    (comment)
                    (statement
                      (set_statement
                        (keyword_set)
                        (object_reference
                          (identifier))
                        (literal)))
                    (statement
                      (set_statement
                        (keyword_set)
                        (object_reference
                          (identifier))
                        (binary_expression
                          (field
                            (identifier))
                          (op_other)
                          (literal))))
                    (statement
                      (procedure
                        (keyword_call)
                        (object_reference
                          (identifier)
                          (identifier))
                        (binary_expression
                          (binary_expression
                            (binary_expression
                              (binary_expression
                                (literal)
                                (op_other)
                                (invocation
                                  (object_reference
                                    (identifier))
                                  (term
                                    (field
                                      (identifier)))))
                              (op_other)
                              (literal))
                            (op_other)
                            (field
                              (identifier)))
                          (op_other)
                          (literal)))))
                  (keyword_end)
                  (keyword_if))
                (comment)
                (keyword_end)
                (keyword_for))
              (comment)
              (statement
                (set_statement
                  (keyword_set)
                  (object_reference
                    (identifier))
                  (literal)))
              (keyword_end))))))

